import { mergeProps as _mergeProps } from "vue";
import { createVNode as _createVNode } from "vue";
import _extends from "@babel/runtime/helpers/esm/extends";
import { reactive } from 'vue'; // Utils

import { callInterceptor } from '../utils/interceptor';
import { createNamespace, addUnit, pick, UnknownProp } from '../utils';
import { BORDER_TOP, BORDER_LEFT } from '../utils/constant'; // Components

import Popup from '../popup';
import Button from '../button';
import ActionBar from '../action-bar';
import ActionBarButton from '../action-bar-button';
import { popupSharedProps, popupSharedPropKeys } from '../popup/shared';
var [createComponent, bem, t] = createNamespace('dialog');
var popupKeys = [...popupSharedPropKeys, 'transition', 'closeOnPopstate'];
export default createComponent({
  props: _extends({}, popupSharedProps, {
    title: String,
    theme: String,
    width: [Number, String],
    message: String,
    callback: Function,
    allowHtml: Boolean,
    className: UnknownProp,
    beforeClose: Function,
    messageAlign: String,
    showCancelButton: Boolean,
    cancelButtonText: String,
    cancelButtonColor: String,
    confirmButtonText: String,
    confirmButtonColor: String,
    closeOnClickOverlay: Boolean,
    transition: {
      type: String,
      default: 'van-dialog-bounce'
    },
    showConfirmButton: {
      type: Boolean,
      default: true
    },
    closeOnPopstate: {
      type: Boolean,
      default: true
    }
  }),
  emits: ['confirm', 'cancel', 'update:show'],

  setup(props, {
    emit,
    slots
  }) {
    var loading = reactive({
      confirm: false,
      cancel: false
    });

    var onUpdateShow = value => {
      emit('update:show', value);
    };

    var close = action => {
      onUpdateShow(false);

      if (props.callback) {
        props.callback(action);
      }
    };

    var handleAction = action => {
      // should not trigger close event when hidden
      if (!props.show) {
        return;
      }

      emit(action);

      if (props.beforeClose) {
        loading[action] = true;
        callInterceptor({
          interceptor: props.beforeClose,
          args: [action],

          done() {
            close(action);
            loading[action] = false;
          },

          canceled() {
            loading[action] = false;
          }

        });
      } else {
        close(action);
      }
    };

    var renderTitle = () => {
      var title = slots.title ? slots.title() : props.title;

      if (title) {
        return _createVNode("div", {
          "class": bem('header', {
            isolated: !props.message && !slots.default
          })
        }, {
          default: () => [title]
        });
      }
    };

    var renderContent = () => {
      if (slots.default) {
        return _createVNode("div", {
          "class": bem('content')
        }, [slots.default()]);
      }

      var {
        title,
        message,
        allowHtml,
        messageAlign
      } = props;

      if (message) {
        var hasTitle = title || slots.title;
        return _createVNode("div", {
          "key": allowHtml ? 1 : 0,
          "class": bem('content', {
            isolated: !hasTitle
          })
        }, [_createVNode("div", _mergeProps({
          "class": bem('message', {
            'has-title': hasTitle,
            [messageAlign]: messageAlign
          })
        }, {
          [allowHtml ? 'innerHTML' : 'textContent']: message
        }), null)]);
      }
    };

    var renderButtons = () => _createVNode("div", {
      "class": [BORDER_TOP, bem('footer')]
    }, [props.showCancelButton && _createVNode(Button, {
      "size": "large",
      "text": props.cancelButtonText || t('cancel'),
      "class": bem('cancel'),
      "style": {
        color: props.cancelButtonColor
      },
      "loading": loading.cancel,
      "onClick": () => {
        handleAction('cancel');
      }
    }, null), props.showConfirmButton && _createVNode(Button, {
      "size": "large",
      "text": props.confirmButtonText || t('confirm'),
      "class": [bem('confirm'), {
        [BORDER_LEFT]: props.showCancelButton
      }],
      "style": {
        color: props.confirmButtonColor
      },
      "loading": loading.confirm,
      "onClick": () => {
        handleAction('confirm');
      }
    }, null)]);

    var renderRoundButtons = () => _createVNode(ActionBar, {
      "class": bem('footer')
    }, {
      default: () => [props.showCancelButton && _createVNode(ActionBarButton, {
        "type": "warning",
        "text": props.cancelButtonText || t('cancel'),
        "class": bem('cancel'),
        "color": props.cancelButtonColor,
        "loading": loading.cancel,
        "onClick": () => {
          handleAction('cancel');
        }
      }, null), props.showConfirmButton && _createVNode(ActionBarButton, {
        "type": "danger",
        "text": props.confirmButtonText || t('confirm'),
        "class": bem('confirm'),
        "color": props.confirmButtonColor,
        "loading": loading.confirm,
        "onClick": () => {
          handleAction('confirm');
        }
      }, null)]
    });

    return () => {
      var {
        width,
        title,
        theme,
        message,
        className
      } = props;
      return _createVNode(Popup, _mergeProps({
        "role": "dialog",
        "class": [bem([theme]), className],
        "style": {
          width: addUnit(width)
        },
        "aria-labelledby": title || message
      }, _extends({}, pick(props, popupKeys), {
        'onUpdate:show': onUpdateShow
      })), {
        default: () => [renderTitle(), renderContent(), theme === 'round-button' ? renderRoundButtons() : renderButtons()]
      });
    };
  }

});